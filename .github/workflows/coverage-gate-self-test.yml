name: Coverage Gate Self-Test

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  fail-path:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Verify coverage gate fails on intentional threshold violation
        run: |
          cat > rust/coverage-thresholds.intentional-fail.txt <<'EOF'
          forge-parity-stub 101
          EOF

          set +e
          scripts/rust-coverage-gate.sh coverage-thresholds.intentional-fail.txt
          status=$?
          set -e

          if [ "$status" -eq 0 ]; then
            echo "expected coverage gate to fail; it passed"
            exit 1
          fi

          echo "coverage gate self-test passed (intentional failure path observed)"
