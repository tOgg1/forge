name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.8
      - name: Run golangci-lint
        run: $(go env GOPATH)/bin/golangci-lint run --timeout=5m

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Run tests
        run: go test -race -coverprofile=coverage.out ./...
      - name: Summarize coverage
        run: |
          go tool cover -func=coverage.out | tee coverage.txt
          {
            echo "## Coverage"
            echo ""
            cat coverage.txt
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage.out
            coverage.txt
          if-no-files-found: ignore

  parity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - uses: dtolnay/rust-toolchain@stable
      - name: Run oracle parity harness
        id: oracle_fixture_parity
        run: go test ./internal/parity -run '^TestOracleFixtureParity$' -count=1
      - name: Run CLI gate baseline test
        id: cli_gate_root_oracle_baseline
        run: go test ./internal/parity -run '^TestCLIGateRootOracleBaseline$' -count=1
      - name: Run synthetic drift detection test
        id: synthetic_drift_detection
        run: go test ./internal/parity -run '^TestCompareTreesDetectsSyntheticDrift$' -count=1
      - name: Run schema fingerprint baseline test
        id: schema_fingerprint_baseline
        run: go test ./internal/parity -run '^TestSchemaFingerprintBaseline$' -count=1
      - name: Run daemon/proto parity gate baseline tests
        id: daemon_proto_gate
        run: go test ./internal/parity -run '^TestDaemonProtoGate' -count=1
      - name: Run proto wire baseline gate tests
        id: proto_wire_gate
        run: go test ./internal/parity -run '^TestProtoWireGate' -count=1
      - name: Run runtime parity gate baseline test
        id: runtime_gate_loop_queue_smart_stop_ledger
        run: go test ./internal/parity -run '^TestRuntimeGateLoopQueueSmartStopLedger$' -count=1
      - name: Run rforged daemon runtime parity suite
        id: rforged_daemon_runtime_parity
        run: scripts/rust-daemon-runtime-parity.sh
      - name: Run fmail parity gate baseline test
        id: fmail_gate_command_and_tui_baseline
        run: go test ./internal/parity -run '^TestFmailGateCommandAndTUIBaseline$' -count=1
      - name: Generate parity diff artifacts on drift
        id: parity_diff_artifacts
        if: failure()
        run: |
          go run ./cmd/parity-artifacts \
            --expected internal/parity/testdata/oracle/expected \
            --actual internal/parity/testdata/oracle/actual \
            --out parity-artifacts || true
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: parity-diff
          path: parity-artifacts/
          if-no-files-found: ignore
      - name: Route parity alerts by owner
        if: failure()
        run: |
          if [ -f parity-artifacts/normalized/parity-alert-routing.md ]; then
            cat parity-artifacts/normalized/parity-alert-routing.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "parity alert routing artifact missing" >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Build parity dashboard artifact
        if: always()
        run: |
          cat > parity-dashboard-input.json <<'JSON'
          {
            "schema_version": "paritydash.input.v1",
            "run": {
              "workflow": "${{ github.workflow }}",
              "run_id": "${{ github.run_id }}",
              "run_attempt": "${{ github.run_attempt }}",
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "repository": "${{ github.repository }}",
              "event_name": "${{ github.event_name }}",
              "server_url": "${{ github.server_url }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            },
            "checks": [
              { "id": "oracle_fixture_parity", "name": "Oracle fixture parity", "outcome": "${{ steps.oracle_fixture_parity.outcome }}" },
              { "id": "cli_gate_root_oracle_baseline", "name": "CLI gate baseline", "outcome": "${{ steps.cli_gate_root_oracle_baseline.outcome }}" },
              { "id": "synthetic_drift_detection", "name": "Synthetic drift detection", "outcome": "${{ steps.synthetic_drift_detection.outcome }}" },
              { "id": "schema_fingerprint_baseline", "name": "Schema fingerprint baseline", "outcome": "${{ steps.schema_fingerprint_baseline.outcome }}" },
              { "id": "daemon_proto_gate", "name": "Daemon/proto gate", "outcome": "${{ steps.daemon_proto_gate.outcome }}" },
              { "id": "proto_wire_gate", "name": "Proto wire gate", "outcome": "${{ steps.proto_wire_gate.outcome }}" },
              { "id": "runtime_gate_loop_queue_smart_stop_ledger", "name": "Runtime gate baseline", "outcome": "${{ steps.runtime_gate_loop_queue_smart_stop_ledger.outcome }}" },
              { "id": "rforged_daemon_runtime_parity", "name": "rforged daemon runtime parity suite", "outcome": "${{ steps.rforged_daemon_runtime_parity.outcome }}" },
              { "id": "fmail_gate_command_and_tui_baseline", "name": "Fmail gate baseline", "outcome": "${{ steps.fmail_gate_command_and_tui_baseline.outcome }}" },
              { "id": "parity_diff_artifacts", "name": "Parity diff artifacts (on drift)", "outcome": "${{ steps.parity_diff_artifacts.outcome }}" }
            ]
          }
          JSON
          go run ./cmd/parity-dashboard --input parity-dashboard-input.json --out parity-dashboard
          cat parity-dashboard/parity-dashboard.md >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: parity-dashboard
          path: parity-dashboard/
          if-no-files-found: error

  baseline-snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Generate baseline snapshot and check drift
        run: scripts/rust-baseline-snapshot.sh build/rust-baseline/latest --check
      - uses: actions/upload-artifact@v4
        with:
          name: rust-baseline-snapshot
          path: build/rust-baseline/latest/
          if-no-files-found: error

  baseline-refresh-protocol:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Baseline refresh protocol dry-run
        run: |
          scripts/rust-baseline-refresh.sh \
            --approval forge-7sd \
            --allow-drift \
            --out-dir build/rust-baseline/protocol
      - uses: actions/upload-artifact@v4
        with:
          name: rust-baseline-refresh-protocol
          path: build/rust-baseline/protocol/baseline-refresh-report.json
          if-no-files-found: error

  rust-boundary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: rust boundary check
        run: scripts/rust-boundary-check.sh

  rust-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: rust frankentui pin check
        run: scripts/rust-frankentui-pin-check.sh
      - name: rust fmt
        working-directory: rust
        run: cargo fmt --all --check
      - name: rust clippy
        working-directory: rust
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: rust test
        working-directory: rust
        run: cargo test --workspace

  db-compat:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - uses: dtolnay/rust-toolchain@stable
      - name: run db compatibility gate checks
        run: scripts/rust-db-compat-check.sh

  rust-coverage:
    runs-on: ubuntu-latest
    needs: [rust-quality]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Fetch base ref for coverage diff
        run: |
          base="${GITHUB_BASE_REF:-main}"
          git fetch --no-tags --prune origin "+refs/heads/${base}:refs/remotes/origin/${base}" --depth=1
      - name: rust coverage (lcov)
        working-directory: rust
        run: |
          cargo llvm-cov \
            --workspace \
            --all-features \
            --lcov \
            --output-path coverage/lcov.info
      - name: Enforce per-crate coverage thresholds and waivers
        run: scripts/rust-coverage-gate.sh
      - name: Summarize rust coverage
        working-directory: rust
        run: |
          {
            echo "## Rust Coverage"
            echo ""
            echo "Per-crate thresholds: rust/coverage-thresholds.txt"
            echo "Waivers: rust/coverage-waivers.txt"
            echo ""
            cargo llvm-cov report --summary-only
            echo ""
            echo "### Per-crate coverage"
            echo ""
            cat coverage/per-crate-summary.txt
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        with:
          name: rust-coverage
          path: |
            rust/coverage/lcov.info
            rust/coverage/per-crate-summary.txt
          if-no-files-found: error

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, parity, baseline-snapshot, baseline-refresh-protocol, rust-boundary, rust-quality, db-compat, rust-coverage]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Build release artifacts
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: build --snapshot --clean
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          if-no-files-found: ignore
