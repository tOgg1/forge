name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.8
      - name: Run golangci-lint
        run: $(go env GOPATH)/bin/golangci-lint run --timeout=5m

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Run tests
        run: go test -race -coverprofile=coverage.out ./...
      - name: Summarize coverage
        run: |
          go tool cover -func=coverage.out | tee coverage.txt
          {
            echo "## Coverage"
            echo ""
            cat coverage.txt
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage.out
            coverage.txt
          if-no-files-found: ignore

  parity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Run oracle parity harness
        run: go test ./internal/parity -run '^TestOracleFixtureParity$' -count=1
      - name: Run synthetic drift detection test
        run: go test ./internal/parity -run '^TestCompareTreesDetectsSyntheticDrift$' -count=1
      - name: Run schema fingerprint baseline test
        run: go test ./internal/parity -run '^TestSchemaFingerprintBaseline$' -count=1
      - name: Generate parity diff artifacts on drift
        if: failure()
        run: |
          go run ./cmd/parity-artifacts \
            --expected internal/parity/testdata/oracle/expected \
            --actual internal/parity/testdata/oracle/actual \
            --out parity-artifacts || true
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: parity-diff
          path: parity-artifacts/
          if-no-files-found: ignore

  baseline-snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Generate baseline snapshot and check drift
        run: scripts/rust-baseline-snapshot.sh build/rust-baseline/latest --check
      - uses: actions/upload-artifact@v4
        with:
          name: rust-baseline-snapshot
          path: build/rust-baseline/latest/
          if-no-files-found: error

  rust-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: rust boundary check
        run: scripts/rust-boundary-check.sh
      - name: rust fmt
        working-directory: rust
        run: cargo fmt --all --check
      - name: rust clippy
        working-directory: rust
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: rust test
        working-directory: rust
        run: cargo test --workspace

  rust-coverage:
    runs-on: ubuntu-latest
    needs: [rust-quality]
    env:
      RUST_COVERAGE_FAIL_UNDER_LINES: "100"
      RUST_COVERAGE_FAIL_UNDER_FUNCTIONS: "100"
      RUST_COVERAGE_FAIL_UNDER_REGIONS: "100"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Enforce per-crate coverage thresholds and waivers
        run: scripts/rust-coverage-gate.sh
      - name: rust coverage
        working-directory: rust
        run: |
          cargo llvm-cov \
            --workspace \
            --all-features \
            --fail-under-lines "${RUST_COVERAGE_FAIL_UNDER_LINES}" \
            --fail-under-functions "${RUST_COVERAGE_FAIL_UNDER_FUNCTIONS}" \
            --fail-under-regions "${RUST_COVERAGE_FAIL_UNDER_REGIONS}" \
            --lcov \
            --output-path coverage/lcov.info
      - name: Summarize rust coverage
        working-directory: rust
        run: |
          {
            echo "## Rust Coverage"
            echo ""
            echo "Per-crate thresholds: rust/coverage-thresholds.txt"
            echo "Waivers: rust/coverage-waivers.txt"
            echo ""
            echo "Thresholds: lines ${RUST_COVERAGE_FAIL_UNDER_LINES}%, functions ${RUST_COVERAGE_FAIL_UNDER_FUNCTIONS}%, regions ${RUST_COVERAGE_FAIL_UNDER_REGIONS}%"
            echo ""
            cargo llvm-cov report --summary-only
            echo ""
            echo "### Per-crate coverage"
            echo ""
            cat coverage/per-crate-summary.txt
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        with:
          name: rust-coverage
          path: |
            rust/coverage/lcov.info
            rust/coverage/per-crate-summary.txt
          if-no-files-found: error

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, parity, baseline-snapshot, rust-quality, rust-coverage]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Build release artifacts
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: build --snapshot --clean
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          if-no-files-found: ignore
