name: Rust Coverage Nightly

on:
  schedule:
    - cron: "41 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rust-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Fetch base ref for coverage diff
        run: |
          git fetch --no-tags --prune origin "+refs/heads/main:refs/remotes/origin/main" --depth=1
      - name: rust coverage (lcov)
        working-directory: .
        run: |
          cargo llvm-cov \
            --workspace \
            --all-features \
            --lcov \
            --output-path coverage/lcov.info
      - name: Enforce per-crate coverage thresholds and waivers
        run: scripts/rust-coverage-gate.sh
      - name: Summarize rust coverage
        working-directory: .
        run: |
          {
            echo "## Rust Coverage (Nightly)"
            echo ""
            echo "Per-crate thresholds: coverage-thresholds.txt"
            echo "Waivers: coverage-waivers.txt"
            echo ""
            cargo llvm-cov report --summary-only
            echo ""
            echo "### Per-crate coverage"
            echo ""
            cat coverage/per-crate-summary.txt
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        with:
          name: rust-coverage-nightly
          path: |
            coverage/lcov.info
            coverage/per-crate-summary.txt
          if-no-files-found: error
